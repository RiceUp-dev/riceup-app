// Replace the problematic functions with these corrected versions:

// Fixed function to load user activities
async function loadUserActivities() {
    if (!currentUser) {
        console.log('No current user');
        return [];
    }
    
    if (!window.firebase || !window.firebase.initialized) {
        console.log('Firebase not initialized');
        return [];
    }
    
    try {
        const { db, doc, getDoc } = window.firebase;
        const userDoc = doc(db, 'users', currentUser.uid);
        const userSnapshot = await getDoc(userDoc);
        
        if (userSnapshot.exists()) {
            const userData = userSnapshot.data();
            console.log('Loaded activities:', userData.activities);
            return userData.activities || [];
        } else {
            // Create user document if it doesn't exist
            const { setDoc } = window.firebase;
            await setDoc(userDoc, { activities: [] });
            return [];
        }
    } catch (error) {
        console.error('Error loading activities:', error);
        return [];
    }
}

// Fixed function to save activity
async function saveActivityToFirebase(activity) {
    if (!currentUser) {
        console.log('No user logged in');
        return;
    }
    
    if (!window.firebase || !window.firebase.initialized) {
        console.log('Firebase not available');
        // Store locally as fallback
        const localActivities = JSON.parse(localStorage.getItem('riceup_activities') || '[]');
        localActivities.push(activity);
        localStorage.setItem('riceup_activities', JSON.stringify(localActivities));
        return;
    }
    
    try {
        const { db, doc, updateDoc, arrayUnion } = window.firebase;
        const userDoc = doc(db, 'users', currentUser.uid);
        
        await updateDoc(userDoc, {
            activities: arrayUnion(activity)
        });
        console.log('Activity saved successfully:', activity);
    } catch (error) {
        console.error('Error saving activity:', error);
        // Fallback to local storage
        const localActivities = JSON.parse(localStorage.getItem('riceup_activities') || '[]');
        localActivities.push(activity);
        localStorage.setItem('riceup_activities', JSON.stringify(localActivities));
    }
}

// Fixed function to get activities for a specific date
function getActivitiesForDate(activities, date) {
    const dateString = date.toISOString().split('T')[0];
    console.log('Looking for activities on:', dateString);
    console.log('Available activities:', activities);
    
    return activities.filter(activity => {
        const activityDate = new Date(activity.date);
        const activityDateString = activityDate.toISOString().split('T')[0];
        return activityDateString === dateString;
    });
}

// Fixed function to update calendar cell display
function updateCalendarCellDisplay(cell, cellDate, manualActivities, scheduledForDate) {
    // Clear existing styling and indicators
    cell.style.backgroundColor = '';
    cell.style.backgroundImage = '';
    cell.className = '';
    const existingIndicator = cell.querySelector('.activity-indicator');
    if (existingIndicator) {
        existingIndicator.remove();
    }
    
    // Reset to basic cell styling
    cell.style.color = '#5C4033';
    
    // 1. Show optimal planting periods in GREEN
    if (isOptimalPlantingDate(cellDate)) {
        cell.classList.add('optimal-planting');
    }
    
    // 2. Check if there's any planting activity recorded
    const userActivities = window.userActivities || [];
    const hasAnyPlanting = userActivities.some(a => a.type === 'planting');
    
    if (hasAnyPlanting) {
        // Show watering schedule in BLUE
        const wateringForDate = scheduledForDate.filter(a => a.scheduledType === 'watering');
        if (wateringForDate.length > 0) {
            const wateringActivity = wateringForDate[0];
            console.log('Watering scheduled for:', cellDate, 'intensity:', wateringActivity.intensity);
            
            switch(wateringActivity.intensity) {
                case 'light':
                    cell.classList.add('watering-light');
                    break;
                case 'normal':
                    cell.classList.add('watering-normal');
                    break;
                case 'heavy':
                    cell.classList.add('watering-heavy');
                    cell.style.color = 'white';
                    break;
            }
        }
        
        // Show fertilizer schedule in BROWN
        const fertilizerForDate = scheduledForDate.filter(a => a.scheduledType === 'fertilizer');
        if (fertilizerForDate.length > 0) {
            const fertilizerActivity = fertilizerForDate[0];
            console.log('Fertilizer scheduled for:', cellDate, 'intensity:', fertilizerActivity.intensity);
            
            switch(fertilizerActivity.intensity) {
                case 'light':
                    cell.classList.add('fertilizer-light');
                    break;
                case 'normal':
                    cell.classList.add('fertilizer-normal');
                    break;
                case 'heavy':
                    cell.classList.add('fertilizer-heavy');
                    cell.style.color = 'white';
                    break;
            }
        }
    }
    
    // 3. Show dots only for COMPLETED activities (what user actually did)
    if (manualActivities.length > 0) {
        cell.classList.add('has-activity');
        
        const indicator = document.createElement('div');
        indicator.className = 'activity-indicator';
        
        // Only show dots for what the farmer has actually done
        manualActivities.forEach(activity => {
            if (activity.type === 'planting') {
                const dot = document.createElement('div');
                dot.className = 'activity-dot planting-dot';
                indicator.appendChild(dot);
            } else if (activity.type === 'watering') {
                const dot = document.createElement('div');
                dot.className = 'activity-dot watering-completed-dot';
                indicator.appendChild(dot);
            } else if (activity.type === 'fertilizer') {
                const dot = document.createElement('div');
                dot.className = 'activity-dot fertilizer-dot';
                indicator.appendChild(dot);
            } else if (activity.type === 'harvest') {
                const dot = document.createElement('div');
                dot.className = 'activity-dot harvest-dot';
                indicator.appendChild(dot);
            }
        });
        
        cell.appendChild(indicator);
    }
    
    // 4. Add today class if applicable
    const today = new Date();
    if (cellDate.toDateString() === today.toDateString()) {
        cell.classList.add('today');
    }
    
    // 5. Add other-month class if needed
    if (cellDate.getMonth() !== currentDate.getMonth()) {
        cell.classList.add('other-month');
    }
}

// Fixed function to update activities list
async function updateActivitiesList() {
    const activities = await loadUserActivities();
    activitiesContainer.innerHTML = '';
    
    // Store activities globally for easy access
    window.userActivities = activities;
    
    if (activities.length === 0) {
        activitiesContainer.innerHTML = '<p>Walang mga aktibidad na naitala.</p>';
        return;
    }
    
    // Sort activities by date (newest first)
    activities.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    activities.forEach(activity => {
        const activityItem = document.createElement('div');
        activityItem.className = 'activity-item';
        
        const activityDate = new Date(activity.date);
        const dateString = activityDate.toLocaleDateString('en-PH', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        let activityDetails = '';
        let activityTypeLabel = '';
        
        switch(activity.type) {
            case 'planting':
                activityTypeLabel = 'Pagtatanim';
                activityDetails = `Uri: ${riceVarieties[activity.variety]?.name || activity.variety}, Laki: ${activity.area} ektarya`;
                break;
            case 'watering':
                activityTypeLabel = 'Pagtutubig';
                activityDetails = `Dami: ${activity.amount}mm, Paraan: ${activity.method}`;
                break;
            case 'fertilizer':
                activityTypeLabel = 'Pag-aabono';
                activityDetails = `Uri: ${activity.fertilizerType}, Dami: ${activity.amount}kg/ha, Paraan: ${activity.method}`;
                break;
            case 'harvest':
                activityTypeLabel = 'Paggapas';
                activityDetails = `Dami: ${activity.amount} sako, Kalidad: ${activity.quality}`;
                break;
            default:
                activityTypeLabel = activity.type;
        }
        
        activityItem.innerHTML = `
            <div class="activity-info">
                <div class="activity-date">${dateString}</div>
                <span class="activity-type ${activity.type}">${activityTypeLabel}</span>
                <div>${activityDetails}</div>
            </div>
            <button class="delete-activity" data-activity='${JSON.stringify(activity).replace(/'/g, "\\'")}'>
                <i class="fas fa-trash"></i>
            </button>
        `;
        
        activitiesContainer.appendChild(activityItem);
    });
    
    // Add event listeners to delete buttons
    document.querySelectorAll('.delete-activity').forEach(button => {
        button.addEventListener('click', async function() {
            const activityJson = this.getAttribute('data-activity').replace(/\\'/g, "'");
            const activity = JSON.parse(activityJson);
            
            if (confirm('Sigurado ka bang gusto mong burahin ang aktibidad na ito?')) {
                await deleteActivityFromFirebase(activity);
                await updateActivitiesList();
                await renderCalendar();
                updateHarvestPrediction();
                updateScheduleInfo();
            }
        });
    });
}

// Fixed function to delete activity
async function deleteActivityFromFirebase(activityToDelete) {
    if (!currentUser) return;
    
    if (!window.firebase || !window.firebase.initialized) {
        // Delete from local storage
        const localActivities = JSON.parse(localStorage.getItem('riceup_activities') || '[]');
        const updatedActivities = localActivities.filter(activity => 
            !(activity.date === activityToDelete.date && 
              activity.type === activityToDelete.type &&
              activity.timestamp === activityToDelete.timestamp)
        );
        localStorage.setItem('riceup_activities', JSON.stringify(updatedActivities));
        return;
    }
    
    try {
        const { db, doc, getDoc, updateDoc } = window.firebase;
        const userDoc = doc(db, 'users', currentUser.uid);
        const userSnapshot = await getDoc(userDoc);
        
        if (userSnapshot.exists()) {
            const userData = userSnapshot.data();
            const updatedActivities = userData.activities.filter(activity => 
                !(activity.date === activityToDelete.date && 
                  activity.type === activityToDelete.type &&
                  activity.timestamp === activityToDelete.timestamp)
            );
            
            await updateDoc(userDoc, {
                activities: updatedActivities
            });
        }
    } catch (error) {
        console.error('Error deleting activity:', error);
    }
}

// Fixed initialization to load activities properly
async function initializeApp() {
    console.log('Initializing app...');
    loadingActivities.style.display = 'block';
    
    // Wait for Firebase
    if (window.firebase && window.firebase.initialized) {
        const { auth, onAuthStateChanged } = window.firebase;
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('User logged in:', user.uid);
                currentUser = user;
                await initCalendar();
            } else {
                console.log('No user logged in, redirecting...');
                window.location.href = '/';
            }
        });
    } else {
        console.log('Firebase not available, using local storage');
        // If Firebase fails, still initialize the calendar with local storage
        setTimeout(async () => {
            await initCalendar();
        }, 500);
    }
}

// Add this debug function to check what's happening
function debugCalendarState() {
    console.log('Current user:', currentUser);
    console.log('User activities:', window.userActivities);
    console.log('Current date:', currentDate);
}
