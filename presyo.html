<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RiceUp - Presyo ng Bigas</title>
  <style>
    * {
      margin: 0; padding: 0; box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #FFF9E6;
      color: #5C4033;
      line-height: 1.6;
      padding-bottom: 70px;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 0px;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
      padding: 0px;
      background-color: #6B8E23;
      border-radius: 0px;
      color: white;
      position: relative;
      height: 100px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 0.3cm;
    }
    .header-image {
      width: 100%; height: auto;
      display: block; margin: 0 auto;
    }
    .price-container {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .dropdown-container {
      margin-bottom: 20px;
    }
    select {
      width: 100%; padding: 12px;
      border-radius: 8px; border: 2px solid #5B3A29;
      background-color: #F8F0E4; color: #5C4033;
      font-size: 16px; cursor: pointer;
    }
    .rice-types-container {
      margin-top: 20px;
    }
    .rice-type {
      display: flex; justify-content: space-between;
      padding: 12px 15px;
      border-bottom: 1px solid #F8F0E4;
    }
    .rice-type:last-child {
      border-bottom: none;
    }
    .rice-type-name {
      font-weight: bold;
    }
    .rice-type-price {
      color: #6B8E23;
      font-weight: bold;
    }
    .print-box {
      background-color: #F8F0E4;
      border-radius: 10px;
      padding: 20px;
      min-height: 100px;
      margin-top: 20px;
      text-align: center;
      font-weight: bold;
    }
    .print-box p {
      margin: 10px 0;
    }
    .loading {
      text-align: center; padding: 20px;
      color: #5C4033;
    }
    .error {
      background-color: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: center;
    }
    .success {
      background-color: #e8f5e8;
      color: #2e7d32;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: center;
    }
    .last-updated {
      font-size: 12px; color: #888;
      text-align: center; margin-top: 10px;
    }
    
    .prediction-section {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .history-section {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Enhanced History Section Styles */
    .history-controls {
      margin-bottom: 20px;
    }

    .filter-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 150px;
    }

    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #5B3A29;
      font-size: 14px;
    }

    .action-row {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .action-btn {
      padding: 10px 15px;
      background-color: #6B8E23;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .action-btn.secondary {
      background-color: #5B3A29;
    }

    .action-btn:hover {
      background-color: #5a7a1c;
    }

    .action-btn.secondary:hover {
      background-color: #4a2f20;
    }

    .results-summary {
      display: flex;
      justify-content: space-between;
      background-color: #F8F0E4;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .summary-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .summary-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 3px;
    }

    .summary-value {
      font-weight: bold;
      color: #5B3A29;
    }

    .history-content-container {
      margin-top: 15px;
    }

    .table-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #F8F0E4;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0;
      font-size: 14px;
    }

    .history-table th,
    .history-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #F8F0E4;
    }

    .history-table th {
      background-color: #6B8E23;
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
    }

    .history-table tr:hover {
      background-color: #F8F0E4;
    }

    .pagination-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      padding: 10px;
      background-color: #F8F0E4;
      border-radius: 8px;
    }

    .pagination-info {
      font-size: 14px;
      color: #666;
      font-weight: bold;
    }

    .pagination-buttons {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .page-numbers {
      padding: 0 15px;
      font-weight: bold;
      color: #5B3A29;
    }

    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .page-size-selector select {
      width: auto;
      padding: 5px 10px;
    }

    .price-positive {
      color: #2e7d32;
      font-weight: bold;
    }
    
    .price-negative {
      color: #c62828;
      font-weight: bold;
    }
    
    .prediction-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .prediction-controls select {
      flex: 1;
    }
    
    .prediction-result {
      background-color: #E8F5E8;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      margin-top: 15px;
    }
    
    .predicted-price {
      font-size: 24px;
      color: #2e7d32;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .pagination-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      background-color: #F8F0E4;
      border-radius: 8px;
    }
    
    .pagination-info {
      font-size: 14px;
      color: #666;
      font-weight: bold;
    }

    .pagination-btn {
      padding: 8px 15px;
      background-color: #6B8E23;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .pagination-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .pagination-btn:hover:not(:disabled) {
      background-color: #5a7a1c;
    }

    .debug-info {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
      color: #6c757d;
    }

    .data-warning {
      background-color: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      border-left: 4px solid #ffc107;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #5B3A29;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 12px 0;
      z-index: 100;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 25px;
      transition: all 0.3s;
      flex: 1;
      text-align: center;
      margin: 0 5px;
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .nav-item:hover {
      background-color: #6B8E23;
      transform: translateY(-3px);
    }
    
    .nav-icon {
      font-size: 1.2rem;
      margin-bottom: 3px;
    }
    
    .nav-label {
      font-size: 0.8rem;
    }
    
    /* Current Prices Type Headers */
    .rice-type-header {
      background-color: #F8F0E4;
      padding: 10px 15px;
      margin-top: 15px;
      border-radius: 8px;
      font-weight: bold;
      color: #5B3A29;
      border-left: 4px solid #6B8E23;
    }
    
    .rice-type-header:first-child {
      margin-top: 0;
    }
    
    .rice-type-header.kadiwa {
      border-left-color: #6B8E23;
    }
    
    .rice-type-header.local {
      border-left-color: #5B3A29;
    }
    
    .rice-type-header.imported {
      border-left-color: #8B4513;
    }
    
    @media (max-width: 768px) {
      .filter-row {
        flex-direction: column;
      }
      
      .filter-group {
        min-width: 100%;
      }
      
      .action-row {
        flex-direction: column;
      }
      
      .results-summary {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .summary-item {
        flex-direction: row;
        gap: 5px;
      }
      
      .pagination-buttons {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .page-size-selector {
        flex-direction: column;
        gap: 5px;
      }
    }

    @media (max-width: 600px) {
      header { height: 90px; }
      .nav-label {
        font-size: 0.7rem;
      }
      .nav-icon {
        font-size: 1rem;
      }
      .nav-item {
        padding: 6px 8px;
        margin: 0 3px;
      }
      .prediction-controls,
      .history-controls {
        flex-direction: column;
      }
      .history-table {
        font-size: 12px;
      }
      .history-table th,
      .history-table td {
        padding: 6px 4px;
      }
      .pagination-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <header>
      <img src="https://uploads.onecompiler.io/4437779jy/4437qj8jp/PresyoTitle.jpg"
           alt="Presyo ng Bigas" class="header-image">
    </header>

    <!-- Connection Status -->
    <div id="connectionStatus" style="display: none;" class="error">
      <p><i class="fas fa-exclamation-triangle"></i> Hindi makakonekta sa server. Pakisubukan muli mamaya.</p>
    </div>

    <!-- Success Status -->
    <div id="successStatus" style="display: none;" class="success">
      <p><i class="fas fa-check-circle"></i> <span id="successMessage">Nakakonekta sa backend server!</span></p>
    </div>

    <!-- Debug Info -->
    <div id="debugInfo" class="debug-info">
      <strong>System Status:</strong>
      <div id="debugContent">Sinusuri ang koneksyon sa backend...</div>
    </div>

    <!-- Current Prices Section -->
    <div class="price-container">
      <div class="dropdown-container">
        <select id="priceTypeFilter" onchange="filterCurrentPrices()">
          <option value="all">Lahat ng Uri ng Bigas</option>
          <option value="KADIWA_RICE_FOR_ALL">Kadiwa</option>
          <option value="LOCAL">Local</option>
          <option value="IMPORTED">Imported</option>
        </select>
      </div>

      <div id="dataWarning" class="data-warning" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i> 
        <span id="warningText">Ang ipinapakitang datos ay maaaring luma. Pakisiguro na ang backend ay naglo-load ng tamang CSV file.</span>
      </div>

      <div class="rice-types-container" id="riceTypesContainer">
        <div class="loading" id="loadingIndicator">
          <i class="fas fa-spinner fa-spin"></i> Kinukuha ang mga presyo...
        </div>
      </div>

      <div class="print-box" id="pricePrintBox">
        <p>Maghintay habang kinukuha ang mga kasalukuyang presyo‚Ä¶</p>
      </div>

      <div class="last-updated" id="lastUpdated">
        Huling na-update: -
      </div>
    </div>

    <!-- Price History Section -->
    <div class="history-section">
      <h3 style="text-align: center; margin-bottom: 15px; color: #5B3A29;">
        <i class="fas fa-history"></i> Kasaysayan ng Presyo
      </h3>
      
      <!-- Enhanced Filter Controls -->
      <div class="history-controls">
        <div class="filter-row">
          <div class="filter-group">
            <label for="historyType">Uri ng Bigas</label>
            <select id="historyType" onchange="filterHistory()">
              <option value="all">Lahat ng Uri</option>
              <option value="KADIWA_RICE_FOR_ALL">Kadiwa</option>
              <option value="LOCAL">Local</option>
              <option value="IMPORTED">Imported</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="historyCategory">Kategorya</label>
            <select id="historyCategory" onchange="filterHistory()">
              <option value="all">Lahat ng Kategorya</option>
              <!-- Options will be loaded dynamically -->
            </select>
          </div>

          <div class="filter-group">
            <label for="historyYear">Taon</label>
            <select id="historyYear" onchange="filterHistory()">
              <option value="all">Lahat ng Taon</option>
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
            </select>
          </div>
        </div>
        
        <div class="action-row">
          <button onclick="loadAllHistory()" class="action-btn">
            <i class="fas fa-download"></i> Kuhanin Lahat ng Data
          </button>
          <button onclick="resetHistoryFilters()" class="action-btn secondary">
            <i class="fas fa-sync"></i> I-reset ang Filter
          </button>
        </div>
      </div>
      
      <!-- Results Summary -->
      <div class="results-summary" id="resultsSummary">
        <div class="summary-item">
          <span class="summary-label">Kabuuang Records:</span>
          <span class="summary-value" id="totalRecords">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Ipinapakita:</span>
          <span class="summary-value" id="showingRecords">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Petsa ng Data:</span>
          <span class="summary-value" id="dateRange">-</span>
        </div>
      </div>
      
      <!-- History Content with Scrollable Table -->
      <div class="history-content-container">
        <div class="table-container" id="historyTableContainer">
          <div class="loading" id="historyLoading">
            <i class="fas fa-spinner fa-spin"></i> Kinukuha ang kasaysayan ng presyo...
          </div>
          
          <table class="history-table" id="historyTable" style="display: none;">
            <thead>
              <tr>
                <th>Petsa</th>
                <th>Uri</th>
                <th>Kategorya</th>
                <th>Presyo (‚Ç±/kg)</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <!-- Data will be populated here -->
            </tbody>
          </table>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination-container" id="paginationContainer" style="display: none;">
          <div class="pagination-info">
            Ipinapakita ang <span id="currentRange">0-0</span> ng <span id="totalCount">0</span> records
          </div>
          <div class="pagination-buttons">
            <button id="firstPageBtn" onclick="goToPage(1)" class="pagination-btn" disabled>
              <i class="fas fa-angle-double-left"></i>
            </button>
            <button id="prevPageBtn" onclick="previousPage()" class="pagination-btn" disabled>
              <i class="fas fa-angle-left"></i> Mas Luma
            </button>
            <div class="page-numbers">
              <span id="currentPage">1</span> / <span id="totalPages">1</span>
            </div>
            <button id="nextPageBtn" onclick="nextPage()" class="pagination-btn" disabled>
              Mas Bago <i class="fas fa-angle-right"></i>
            </button>
            <button id="lastPageBtn" onclick="goToLastPage()" class="pagination-btn" disabled>
              <i class="fas fa-angle-double-right"></i>
            </button>
          </div>
          <div class="page-size-selector">
            <label for="pageSize">Records per page:</label>
            <select id="pageSize" onchange="changePageSize()">
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
              <option value="500">500</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Price Prediction Section -->
    <div class="prediction-section">
      <h3 style="text-align: center; margin-bottom: 15px; color: #5B3A29;">
        <i class="fas fa-chart-line"></i> Hula ng Presyo sa Hinaharap
      </h3>
      
      <div class="prediction-controls">
        <select id="predictionType">
          <option value="">Pumili ng Uri ng Bigas</option>
          <!-- Options will be loaded dynamically -->
        </select>
        
        <select id="predictionWeeks">
          <option value="1">1 Linggo Mula Ngayon</option>
          <option value="2">2 Linggo Mula Ngayon</option>
          <option value="4">1 Buwan Mula Ngayon</option>
          <option value="8">2 Buwan Mula Ngayon</option>
          <option value="12">3 Buwan Mula Ngayon</option>
          <option value="24">6 Buwan Mula Ngayon</option>
        </select>
      </div>
      
      <button onclick="predictPrice()" style="
        width: 100%;
        padding: 12px;
        background-color: #6B8E23;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-bottom: 15px;
      ">
        <i class="fas fa-calculator"></i> Hulaan ang Presyo
      </button>

      <div id="predictionDebug" style="display: none; background: #f0f8ff; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 12px;">
        <strong>Prediction Debug:</strong>
        <div id="predictionDebugContent"></div>
      </div>
      
      <div class="prediction-result" id="predictionResult" style="display: none;">
        <p>Tinatayang Presyo:</p>
        <div class="predicted-price" id="predictedPrice">-</div>
        <p id="predictionDetails">-</p>
        <small>Batay sa pinakabagong datos mula sa iyong CSV file</small>
      </div>

      <div class="loading" id="predictionLoading" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> Kinakalkula ang hula...
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="kalendaryo.html" class="nav-item">
      <i class="fas fa-calendar-alt nav-icon"></i>
      <span class="nav-label">Kalendaryo ng Pagsasaka</span>
    </a>
    <a href="suriin.html" class="nav-item">
      <i class="fas fa-search nav-icon"></i>
      <span class="nav-label">Suriin ang Palay</span>
    </a>
    <a href="tanong.html" class="nav-item">
      <i class="fas fa-question-circle nav-icon"></i>
      <span class="nav-label">Ask Juan</span>
    </a>
    <a href="index.html" class="nav-item">
      <i class="fas fa-sign-out-alt nav-icon"></i>
      <span class="nav-label">Log Out</span>
    </a>
  </nav>

  <script>
    // üîÑ BACKEND URL - UPDATE THIS WITH YOUR ACTUAL RENDER URL
    const API_URL = 'https://riceup-backend.onrender.com';
    let backendOnline = false;

    // Store available types and current data globally
    let availableRiceTypes = {};
    let currentPricesData = [];
    let currentFilter = 'all';

    // Enhanced Price History Variables
    let historyData = [];
    let filteredHistoryData = [];
    let currentHistoryPage = 1;
    let historyPageSize = 100;
    let totalHistoryPages = 1;

    // Enhanced fetch with timeout and retry
    async function fetchWithTimeout(url, options = {}) {
      const { timeout = 15000, retries = 1 } = options;
      
      for (let attempt = 0; attempt <= retries; attempt++) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        
        try {
          const response = await fetch(url, {
            ...options,
            signal: controller.signal
          });
          clearTimeout(id);
          return response;
        } catch (error) {
          clearTimeout(id);
          if (attempt === retries) throw error;
          console.log(`Retrying ${url}... (attempt ${attempt + 1})`);
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }

    // Update debug info
    function updateDebugInfo(message, isError = false) {
      const debugContent = document.getElementById('debugContent');
      debugContent.innerHTML = message;
      debugContent.style.color = isError ? '#dc3545' : '#28a745';
    }

    // Check backend connection first
    async function checkBackendConnection() {
      try {
        console.log('üîç Checking backend connection to:', API_URL);
        updateDebugInfo('Sinusuri ang koneksyon sa backend...');
        
        const response = await fetchWithTimeout(`${API_URL}/api/health`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
          timeout: 10000
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Backend is online:', data);
          backendOnline = true;
          
          document.getElementById('connectionStatus').style.display = 'none';
          document.getElementById('successStatus').style.display = 'block';
          document.getElementById('successMessage').textContent = 
            `Nakakonekta sa backend! ${data.data?.total_records || 0} records loaded`;
          
          updateDebugInfo(`‚úÖ Backend connected: ${data.data?.status || 'OK'}`);
          return true;
        } else {
          throw new Error(`Backend responded with status: ${response.status}`);
        }
      } catch (error) {
        console.error('‚ùå Backend connection failed:', error);
        backendOnline = false;
        document.getElementById('connectionStatus').style.display = 'block';
        document.getElementById('successStatus').style.display = 'none';
        updateDebugInfo(`‚ùå Connection failed: ${error.message}`, true);
        
        const connectionStatus = document.getElementById('connectionStatus');
        connectionStatus.innerHTML = `
          <p><i class="fas fa-exclamation-triangle"></i> Hindi makakonekta sa server. Pakisubukan muli mamaya.</p>
          <button onclick="retryConnection()" style="
            margin-top: 10px;
            padding: 8px 16px;
            background: #6B8E23;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
          ">
            <i class="fas fa-redo"></i> Subukan Muli
          </button>
        `;
        return false;
      }
    }

    // Add retry function
    function retryConnection() {
      initializeApp();
    }

    // Load available rice types from backend
    async function loadRiceTypes() {
      if (!backendOnline) {
        console.log('Backend offline, using hardcoded rice types');
        availableRiceTypes = {
          'KADIWA_RICE_FOR_ALL': ['Premium', 'Well_Milled', 'Regular_Milled', 'P20'],
          'LOCAL': ['Special', 'Premium', 'Well_Milled', 'Regular_Milled'],
          'IMPORTED': ['Special', 'Premium', 'Well_Milled', 'Regular_Milled'],
          'NFA_RICE': ['Well_Milled']
        };
        
        populateDropdowns(availableRiceTypes);
        updateDebugInfo('‚úÖ Gamit ang mga hardcoded na uri ng bigas');
        return;
      }

      try {
        console.log('üì• Loading rice types from:', `${API_URL}/api/prices/types`);
        updateDebugInfo('Kumukuha ng mga uri ng bigas...');
        
        const response = await fetchWithTimeout(`${API_URL}/api/prices/types`, {
          timeout: 10000
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Received rice types response:', data);
          
          if (data.success && data.data) {
            availableRiceTypes = data.data;
          } else {
            availableRiceTypes = data;
          }
          
          console.log('üìã Available rice types:', availableRiceTypes);
          populateDropdowns(availableRiceTypes);
          updateDebugInfo(`‚úÖ Mga uri ng bigas ay nakuha na (${Object.keys(availableRiceTypes).length} types)`);
        } else {
          console.error('‚ùå API response not OK for types:', response.status);
          throw new Error(`API responded with status: ${response.status}`);
        }
      } catch (error) {
        console.error('‚ùå Error loading rice types:', error);
        
        console.log('üîÑ Using hardcoded rice types based on CSV data');
        availableRiceTypes = {
          'KADIWA_RICE_FOR_ALL': ['Premium', 'Well_Milled', 'Regular_Milled', 'P20'],
          'LOCAL': ['Special', 'Premium', 'Well_Milled', 'Regular_Milled'],
          'IMPORTED': ['Special', 'Premium', 'Well_Milled', 'Regular_Milled'],
          'NFA_RICE': ['Well_Milled']
        };
        
        populateDropdowns(availableRiceTypes);
        updateDebugInfo('‚úÖ Gamit ang mga hardcoded na uri ng bigas');
      }
    }

    function populateDropdowns(typesData) {
      const predictionTypeSelect = document.getElementById('predictionType');
      const historyCategorySelect = document.getElementById('historyCategory');
      
      console.log('üìã Populating dropdowns with:', typesData);
      
      predictionTypeSelect.innerHTML = '<option value="">Pumili ng Uri ng Bigas</option>';
      historyCategorySelect.innerHTML = '<option value="all">Lahat ng Kategorya</option>';
      
      let totalOptions = 0;
      
      for (const [riceType, categories] of Object.entries(typesData)) {
        if (Array.isArray(categories)) {
          categories.forEach(category => {
            if (riceType === 'NFA_RICE') return;
            
            const displayName = getDisplayName(riceType, category);
            const value = `${riceType}|${category}`;
            
            const predictionOption = new Option(displayName, value);
            predictionTypeSelect.add(predictionOption);
            
            const historyOption = new Option(displayName, value);
            historyCategorySelect.add(historyOption);
            
            totalOptions++;
          });
        }
      }
      
      console.log(`‚úÖ Added ${totalOptions} options to dropdowns`);
    }

    function getDisplayName(type, category) {
      const typeNames = {
        'KADIWA_RICE_FOR_ALL': 'Kadiwa',
        'LOCAL': 'Local',
        'IMPORTED': 'Imported',
        'NFA_RICE': 'NFA'
      };
      
      const categoryNames = {
        'Well_Milled': 'Well Milled',
        'Special': 'Special',
        'Premium': 'Premium', 
        'Regular_Milled': 'Regular Milled',
        'P20': 'P20'
      };
      
      return `${typeNames[type] || type} - ${categoryNames[category] || category}`;
    }

    // Load current prices
    async function loadCurrentPrices() {
      if (!backendOnline) {
        showError('riceTypesContainer', 'Hindi makakonekta sa server upang kunin ang mga presyo.');
        showSampleData();
        return;
      }

      const loadingIndicator = document.getElementById('loadingIndicator');
      const riceContainer = document.getElementById('riceTypesContainer');
      
      loadingIndicator.style.display = 'block';
      riceContainer.innerHTML = '';
      riceContainer.appendChild(loadingIndicator);

      try {
        console.log('üí∞ Fetching current prices from:', `${API_URL}/api/prices/current`);
        updateDebugInfo('Kumukuha ng mga kasalukuyang presyo...');
        
        const response = await fetchWithTimeout(`${API_URL}/api/prices/current`, {
          timeout: 20000
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Received current prices response:', data);
          
          currentPricesData = [];
          
          if (data.success && data.data) {
            currentPricesData = data.data.current_prices || [];
            console.log('üìä Current prices data:', currentPricesData);
            
            checkDataFreshness(currentPricesData);
            
            const asOfDate = data.data.as_of_date;
            displayCurrentPrices(currentPricesData, 'all', asOfDate);
            updateDebugInfo(`‚úÖ Mga kasalukuyang presyo ay nakuha na (${currentPricesData.length} records)`);
          } else {
            throw new Error('Invalid response format from server');
          }
        } else {
          const errorData = await response.json();
          throw new Error(errorData.error || `API responded with status: ${response.status}`);
        }
      } catch (error) {
        console.error('‚ùå Error loading prices:', error);
        showError('riceTypesContainer', `Hindi makakuha ng mga kasalukuyang presyo: ${error.message}`);
        updateDebugInfo(`‚ùå Hindi makakuha ng mga presyo: ${error.message}`, true);
        
        showSampleData();
      }
    }

    // Fallback sample data display
    function showSampleData() {
      const riceContainer = document.getElementById('riceTypesContainer');
      const priceBox = document.getElementById('pricePrintBox');
      
      const sampleData = [
        { type: 'LOCAL', category: 'Special', price: 58.50 },
        { type: 'LOCAL', category: 'Premium', price: 53.50 },
        { type: 'LOCAL', category: 'Well_Milled', price: 48.00 },
        { type: 'IMPORTED', category: 'Special', price: 57.00 },
        { type: 'IMPORTED', category: 'Premium', price: 52.00 },
        { type: 'KADIWA_RICE_FOR_ALL', category: 'Well_Milled', price: 40.00 }
      ];
      
      displayCurrentPrices(sampleData, 'all', new Date());
      
      const warningDiv = document.getElementById('dataWarning');
      warningDiv.style.display = 'block';
      document.getElementById('warningText').textContent = 
        '‚ö†Ô∏è Ipinapakita ang sample data. Ang backend ay hindi available.';
    }

    // Check if data is recent
    function checkDataFreshness(prices) {
      if (!prices || prices.length === 0) return;
      
      const currentYear = new Date().getFullYear();
      let latestDate = null;
      
      prices.forEach(price => {
        if (price.date) {
          const priceDate = new Date(price.date);
          if (!latestDate || priceDate > latestDate) {
            latestDate = priceDate;
          }
        }
      });
      
      const warningDiv = document.getElementById('dataWarning');
      const warningText = document.getElementById('warningText');
      
      if (latestDate) {
        const latestDateStr = latestDate.toLocaleDateString('en-PH');
        const latestYear = latestDate.getFullYear();
        
        if (latestYear < currentYear) {
          warningText.textContent = `‚ÑπÔ∏è Pinakabagong datos: ${latestDateStr}`;
          warningDiv.style.display = 'block';
        } else {
          warningDiv.style.display = 'none';
        }
      }
    }

    // Display current prices - LIMITED TO 4 PER TYPE
    function displayCurrentPrices(prices, filterType, asOfDate) {
      const riceContainer = document.getElementById('riceTypesContainer');
      const priceBox = document.getElementById('pricePrintBox');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const lastUpdated = document.getElementById('lastUpdated');

      loadingIndicator.style.display = 'none';
      riceContainer.innerHTML = '';

      if (!prices || prices.length === 0) {
        riceContainer.innerHTML = '<div class="error">Walang presyo na available.</div>';
        priceBox.innerHTML = '<p>Walang datos na available</p>';
        return;
      }

      let filteredPrices = prices.filter(price => price.type !== 'NFA_RICE');
      if (filterType !== 'all') {
        filteredPrices = filteredPrices.filter(price => price.type === filterType);
      }

      if (filteredPrices.length === 0) {
        riceContainer.innerHTML = '<div class="error">Walang presyo na available para sa napiling uri.</div>';
        priceBox.innerHTML = '<p>Walang datos para sa napiling uri</p>';
        return;
      }

      // Group prices by type and limit to 4 per type
      const groupedPrices = {};
      const typeLimits = {
        'KADIWA_RICE_FOR_ALL': 4,
        'LOCAL': 4,
        'IMPORTED': 4
      };

      // Initialize groups
      Object.keys(typeLimits).forEach(type => {
        groupedPrices[type] = [];
      });

      // Sort and group prices by type
      filteredPrices.forEach(price => {
        if (groupedPrices[price.type] && groupedPrices[price.type].length < typeLimits[price.type]) {
          groupedPrices[price.type].push(price);
        }
      });

      // Display prices by type with headers
      Object.keys(groupedPrices).forEach(type => {
        const typePrices = groupedPrices[type];
        if (typePrices.length > 0) {
          // Add type header
          const headerElement = document.createElement('div');
          headerElement.className = `rice-type-header ${type.toLowerCase().replace('_rice_for_all', '')}`;
          headerElement.innerHTML = `
            <i class="fas fa-tag"></i> ${getDisplayName(type, '')}
          `;
          riceContainer.appendChild(headerElement);

          // Add prices for this type
          typePrices.forEach(price => {
            const displayName = getDisplayName(price.type, price.category);
            const riceElement = document.createElement('div');
            riceElement.className = 'rice-type';
            riceElement.innerHTML = `
              <span class="rice-type-name">${displayName.split(' - ')[1]}</span>
              <span class="rice-type-price">‚Ç±${typeof price.price === 'number' ? price.price.toFixed(2) : price.price}/kg</span>
            `;
            riceContainer.appendChild(riceElement);
          });
        }
      });

      // Calculate average price from all displayed prices
      const allDisplayedPrices = Object.values(groupedPrices).flat();
      const validPrices = allDisplayedPrices.filter(price => price.price > 0);
      const averagePrice = validPrices.length > 0 ? 
        validPrices.reduce((sum, price) => {
          const priceValue = typeof price.price === 'number' ? price.price : parseFloat(price.price);
          return sum + priceValue;
        }, 0) / validPrices.length : 0;
      
      priceBox.innerHTML = `
        <p>Average Presyo:</p>
        <p>‚Ç±${averagePrice.toFixed(2)}/kg</p>
        <p><small>Batay sa ${validPrices.length} uri ng bigas</small></p>
      `;

      if (asOfDate) {
        try {
          lastUpdated.textContent = `Huling na-update: ${new Date(asOfDate).toLocaleDateString('en-PH')}`;
        } catch (e) {
          lastUpdated.textContent = `Huling na-update: ${asOfDate}`;
        }
      }
    }

    // Filter current prices
    function filterCurrentPrices() {
      const filterType = document.getElementById('priceTypeFilter').value;
      currentFilter = filterType;
      
      if (currentPricesData.length > 0) {
        const asOfDate = document.getElementById('lastUpdated').textContent.replace('Huling na-update: ', '');
        displayCurrentPrices(currentPricesData, filterType, asOfDate);
      }
    }

    // Enhanced Price History Functions
    async function loadAllHistory() {
      if (!backendOnline) {
        showError('historyTableContainer', 'Hindi makakonekta sa server upang kunin ang kasaysayan ng presyo.');
        return;
      }

      const historyLoading = document.getElementById('historyLoading');
      const historyTable = document.getElementById('historyTable');
      const historyTableBody = document.getElementById('historyTableBody');
      const paginationContainer = document.getElementById('paginationContainer');

      historyLoading.style.display = 'block';
      historyTable.style.display = 'none';
      paginationContainer.style.display = 'none';
      historyTableBody.innerHTML = '';

      try {
        console.log('üìä Fetching all history data...');
        updateDebugInfo('Kumukuha ng kasaysayan ng presyo...');
        
        // Use the optimized endpoint to get all data
        const response = await fetchWithTimeout(`${API_URL}/api/prices/historical/optimized?limit=5000`, {
          timeout: 30000
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Received history data response:', data);
          
          if (data.success && data.data) {
            historyData = data.data.historical_data || [];
            console.log(`üìä Loaded ${historyData.length} history records`);
            
            // Remove duplicates
            historyData = removeDuplicateHistory(historyData);
            console.log(`üìä After removing duplicates: ${historyData.length} records`);
            
            // Sort by date (newest first)
            historyData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Apply initial filters
            filterHistoryData();
            updateDebugInfo(`‚úÖ Kasaysayan ng presyo ay nakuha na (${historyData.length} records)`);
          } else {
            throw new Error('Invalid response format from server');
          }
        } else {
          throw new Error(`API responded with status: ${response.status}`);
        }
      } catch (error) {
        console.error('‚ùå Error loading history:', error);
        showError('historyTableContainer', `Hindi makakuha ng kasaysayan ng presyo: ${error.message}`);
        updateDebugInfo(`‚ùå Hindi makakuha ng kasaysayan: ${error.message}`, true);
      } finally {
        historyLoading.style.display = 'none';
      }
    }

    // Filter history data based on selected filters
    function filterHistoryData() {
      const historyType = document.getElementById('historyType').value;
      const historyCategory = document.getElementById('historyCategory').value;
      const historyYear = document.getElementById('historyYear').value;
      
      filteredHistoryData = historyData.filter(item => {
        // Filter by type
        if (historyType !== 'all' && item.type !== historyType) {
          return false;
        }
        
        // Filter by category
        if (historyCategory !== 'all') {
          const [type, category] = historyCategory.split('|');
          if (item.type !== type || item.category !== category) {
            return false;
          }
        }
        
        // Filter by year
        if (historyYear !== 'all') {
          const itemYear = new Date(item.date).getFullYear();
          if (itemYear.toString() !== historyYear) {
            return false;
          }
        }
        
        return true;
      });
      
      // Reset to first page
      currentHistoryPage = 1;
      
      // Update UI
      updateHistoryDisplay();
      updateResultsSummary();
    }

    // Update the history table display
    function updateHistoryDisplay() {
      const historyTable = document.getElementById('historyTable');
      const historyTableBody = document.getElementById('historyTableBody');
      const paginationContainer = document.getElementById('paginationContainer');
      
      if (filteredHistoryData.length === 0) {
        historyTable.style.display = 'none';
        paginationContainer.style.display = 'none';
        historyTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Walang datos na available para sa napiling filter.</td></tr>';
        return;
      }
      
      // Calculate pagination
      totalHistoryPages = Math.ceil(filteredHistoryData.length / historyPageSize);
      const startIndex = (currentHistoryPage - 1) * historyPageSize;
      const endIndex = Math.min(startIndex + historyPageSize, filteredHistoryData.length);
      const currentPageData = filteredHistoryData.slice(startIndex, endIndex);
      
      // Populate table
      historyTableBody.innerHTML = '';
      
      currentPageData.forEach(item => {
        const priceValue = typeof item.price === 'number' ? item.price.toFixed(2) : parseFloat(item.price).toFixed(2);
        const itemDate = new Date(item.date);
        const dateDisplay = itemDate.toLocaleDateString('en-PH');
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${dateDisplay}</td>
          <td>${getDisplayName(item.type, '').split(' - ')[0]}</td>
          <td>${getDisplayName('', item.category).split(' - ')[1] || item.category}</td>
          <td><strong>‚Ç±${priceValue}</strong></td>
        `;
        historyTableBody.appendChild(row);
      });
      
      // Update pagination controls
      updatePaginationControls(startIndex, endIndex);
      
      // Show table and pagination
      historyTable.style.display = 'table';
      paginationContainer.style.display = 'flex';
    }

    // Update pagination controls
    function updatePaginationControls(startIndex, endIndex) {
      document.getElementById('currentRange').textContent = `${startIndex + 1}-${endIndex}`;
      document.getElementById('totalCount').textContent = filteredHistoryData.length;
      document.getElementById('currentPage').textContent = currentHistoryPage;
      document.getElementById('totalPages').textContent = totalHistoryPages;
      
      // Enable/disable pagination buttons
      document.getElementById('firstPageBtn').disabled = currentHistoryPage === 1;
      document.getElementById('prevPageBtn').disabled = currentHistoryPage === 1;
      document.getElementById('nextPageBtn').disabled = currentHistoryPage === totalHistoryPages;
      document.getElementById('lastPageBtn').disabled = currentHistoryPage === totalHistoryPages;
    }

    // Update results summary
    function updateResultsSummary() {
      document.getElementById('totalRecords').textContent = historyData.length;
      document.getElementById('showingRecords').textContent = filteredHistoryData.length;
      
      // Calculate date range
      if (filteredHistoryData.length > 0) {
        const oldestDate = new Date(filteredHistoryData[filteredHistoryData.length - 1].date);
        const newestDate = new Date(filteredHistoryData[0].date);
        document.getElementById('dateRange').textContent = 
          `${oldestDate.toLocaleDateString('en-PH')} - ${newestDate.toLocaleDateString('en-PH')}`;
      } else {
        document.getElementById('dateRange').textContent = '-';
      }
    }

    // Pagination functions
    function previousPage() {
      if (currentHistoryPage > 1) {
        currentHistoryPage--;
        updateHistoryDisplay();
      }
    }

    function nextPage() {
      if (currentHistoryPage < totalHistoryPages) {
        currentHistoryPage++;
        updateHistoryDisplay();
      }
    }

    function goToPage(page) {
      if (page >= 1 && page <= totalHistoryPages) {
        currentHistoryPage = page;
        updateHistoryDisplay();
      }
    }

    function goToLastPage() {
      currentHistoryPage = totalHistoryPages;
      updateHistoryDisplay();
    }

    function changePageSize() {
      historyPageSize = parseInt(document.getElementById('pageSize').value);
      currentHistoryPage = 1;
      updateHistoryDisplay();
    }

    // Filter history when dropdowns change
    function filterHistory() {
      if (historyData.length > 0) {
        filterHistoryData();
      }
    }

    // Reset all filters
    function resetHistoryFilters() {
      document.getElementById('historyType').value = 'all';
      document.getElementById('historyCategory').value = 'all';
      document.getElementById('historyYear').value = 'all';
      document.getElementById('pageSize').value = '100';
      
      if (historyData.length > 0) {
        filterHistoryData();
      }
    }

    // Function to remove duplicate history records
    function removeDuplicateHistory(data) {
      const seen = new Set();
      const uniqueData = [];
      
      data.forEach(item => {
        const key = `${item.date}_${item.type}_${item.category}`;
        
        if (!seen.has(key)) {
          seen.add(key);
          uniqueData.push(item);
        }
      });
      
      return uniqueData;
    }

    // Price Prediction
    async function predictPrice() {
      if (!backendOnline) {
        alert('Hindi makakonekta sa server. Pakisubukan muli mamaya.');
        return;
      }

      const selectedValue = document.getElementById('predictionType').value;
      
      if (!selectedValue) {
        alert('Mangyaring pumili ng uri ng bigas muna.');
        return;
      }
      
      const [riceType, category] = selectedValue.split('|');
      const weeksAhead = parseInt(document.getElementById('predictionWeeks').value);
      const resultDiv = document.getElementById('predictionResult');
      const loadingDiv = document.getElementById('predictionLoading');
      const priceDiv = document.getElementById('predictedPrice');
      const detailsDiv = document.getElementById('predictionDetails');

      loadingDiv.style.display = 'block';
      resultDiv.style.display = 'none';

      try {
        console.log('üîÆ Making prediction request to:', `${API_URL}/api/predict`);
        updateDebugInfo('Gumagawa ng hula sa presyo...');
        
        const response = await fetchWithTimeout(`${API_URL}/api/predict`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: riceType,
            category: category,
            weeks_ahead: weeksAhead
          }),
          timeout: 20000
        });

        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Prediction result:', data);
          
          const predictedPrice = data.data?.predicted_price || data.predicted_price;
          if (predictedPrice) {
            const priceValue = parseFloat(predictedPrice);
            priceDiv.textContent = `‚Ç±${priceValue.toFixed(2)}/kg`;
            
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + (weeksAhead * 7));
            const futureDateStr = futureDate.toLocaleDateString('en-PH');
            
            detailsDiv.textContent = `Presyo ng ${getDisplayName(riceType, category)} para sa ${futureDateStr} (${weeksAhead} linggo mula ngayon)`;
            resultDiv.style.display = 'block';
            updateDebugInfo('‚úÖ Hula sa presyo ay nakumpleto');
          } else {
            throw new Error('Walang prediction result na naibalik');
          }
        } else {
          const errorText = await response.text();
          throw new Error(`Prediction failed: ${response.status}`);
        }
      } catch (error) {
        console.error('‚ùå Prediction error:', error);
        priceDiv.textContent = '‚Ç±--.--/kg';
        detailsDiv.textContent = `Hindi makabuo ng hula: ${error.message}`;
        resultDiv.style.display = 'block';
        updateDebugInfo(`‚ùå Hindi makabuo ng hula: ${error.message}`, true);
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Utility functions
    function showError(containerId, message) {
      const container = document.getElementById(containerId);
      container.innerHTML = `<div class="error">${message}</div>`;
    }

    // Initialize the application
    async function initializeApp() {
      console.log('üöÄ Initializing RiceUp application...');
      updateDebugInfo('Inisyal ang aplikasyon...');
      
      try {
        // First check backend connection
        const connected = await checkBackendConnection();
        
        if (connected) {
          // Load rice types FIRST (this populates the dropdowns)
          await loadRiceTypes();
          
          // Then load other data in parallel
          await Promise.all([
            loadCurrentPrices(),
            loadAllHistory()
          ]);
          
          console.log('‚úÖ RiceUp application initialized successfully!');
          updateDebugInfo('‚úÖ Aplikasyon ay handa na!');
        } else {
          console.error('‚ùå Application initialization failed: Backend offline');
          // Still try to load with fallback data
          await loadRiceTypes();
          showSampleData();
        }
      } catch (error) {
        console.error('‚ùå Application initialization error:', error);
        updateDebugInfo(`‚ùå Error sa aplikasyon: ${error.message}`, true);
        
        // Load with fallback data even if initialization fails
        await loadRiceTypes();
        showSampleData();
      }
    }

    // Start the application
    window.onload = initializeApp;
  </script>
</body>
</html>
