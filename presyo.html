<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RiceUp - Presyo ng Bigas</title>
  <style>
    * {
      margin: 0; padding: 0; box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #FFF9E6;
      color: #5C4033;
      line-height: 1.6;
      padding-bottom: 70px;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 0px;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
      padding: 0px;
      background-color: #6B8E23;
      border-radius: 0px;
      color: white;
      position: relative;
      height: 100px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 0.3cm;
    }
    .header-image {
      width: 100%; height: auto;
      display: block; margin: 0 auto;
    }
    .price-container {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .dropdown-container {
      margin-bottom: 20px;
    }
    select {
      width: 100%; padding: 12px;
      border-radius: 8px; border: 2px solid #5B3A29;
      background-color: #F8F0E4; color: #5C4033;
      font-size: 16px; cursor: pointer;
    }
    .rice-types-container {
      margin-top: 20px;
    }
    .rice-type {
      display: flex; justify-content: space-between;
      padding: 12px 15px;
      border-bottom: 1px solid #F8F0E4;
    }
    .rice-type:last-child {
      border-bottom: none;
    }
    .rice-type-name {
      font-weight: bold;
    }
    .rice-type-price {
      color: #6B8E23;
      font-weight: bold;
    }
    .print-box {
      background-color: #F8F0E4;
      border-radius: 10px;
      padding: 20px;
      min-height: 100px;
      margin-top: 20px;
      text-align: center;
      font-weight: bold;
    }
    .print-box p {
      margin: 10px 0;
    }
    .loading {
      text-align: center; padding: 20px;
      color: #5C4033;
    }
    .error {
      background-color: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: center;
    }
    .last-updated {
      font-size: 12px; color: #888;
      text-align: center; margin-top: 10px;
    }
    
    .prediction-section {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .history-section {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .history-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
    }
    
    .history-table th,
    .history-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #F8F0E4;
    }
    
    .history-table th {
      background-color: #6B8E23;
      color: white;
      font-weight: bold;
    }
    
    .history-table tr:hover {
      background-color: #F8F0E4;
    }
    
    .price-positive {
      color: #2e7d32;
      font-weight: bold;
    }
    
    .price-negative {
      color: #c62828;
      font-weight: bold;
    }
    
    .prediction-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .prediction-controls select {
      flex: 1;
    }
    
    .prediction-result {
      background-color: #E8F5E8;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      margin-top: 15px;
    }
    
    .predicted-price {
      font-size: 24px;
      color: #2e7d32;
      font-weight: bold;
      margin: 10px 0;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #5B3A29;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 12px 0;
      z-index: 100;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 25px;
      transition: all 0.3s;
      flex: 1;
      text-align: center;
      margin: 0 5px;
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .nav-item:hover {
      background-color: #6B8E23;
      transform: translateY(-3px);
    }
    
    .nav-icon {
      font-size: 1.2rem;
      margin-bottom: 3px;
    }
    
    .nav-label {
      font-size: 0.8rem;
    }
    
    @media (max-width: 600px) {
      header { height: 90px; }
      .nav-label {
        font-size: 0.7rem;
      }
      .nav-icon {
        font-size: 1rem;
      }
      .nav-item {
        padding: 6px 8px;
        margin: 0 3px;
      }
      .prediction-controls,
      .history-controls {
        flex-direction: column;
      }
      .history-table {
        font-size: 12px;
      }
      .history-table th,
      .history-table td {
        padding: 6px 4px;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <header>
      <img src="https://uploads.onecompiler.io/4437779jy/4437qj8jp/PresyoTitle.jpg"
           alt="Presyo ng Bigas" class="header-image">
    </header>

    <!-- Current Prices Section -->
    <div class="price-container">
      <div class="dropdown-container">
        <select id="priceTypeFilter" onchange="loadCurrentPrices()">
          <option value="all">Lahat ng Uri ng Bigas</option>
          <option value="KADIWA">Kadiwa</option>
          <option value="LOCAL">Local</option>
          <option value="IMPORTED">Imported</option>
        </select>
      </div>

      <div class="rice-types-container" id="riceTypesContainer">
        <div class="loading" id="loadingIndicator">
          Kinukuha ang mga presyo...
        </div>
      </div>

      <div class="print-box" id="pricePrintBox">
        <p>Maghintay habang kinukuha ang mga kasalukuyang presyoâ€¦</p>
      </div>

      <div class="last-updated" id="lastUpdated">
        Huling na-update: -
      </div>
    </div>

    <!-- Price History Section -->
    <div class="history-section">
      <h3 style="text-align: center; margin-bottom: 15px; color: #5B3A29;">
        <i class="fas fa-history"></i> Kasaysayan ng Presyo
      </h3>
      
      <div class="history-controls">
        <select id="historyType" onchange="showPriceHistory()">
          <option value="all">Lahat ng Uri</option>
          <option value="KADIWA">Kadiwa</option>
          <option value="LOCAL">Local</option>
          <option value="IMPORTED">Imported</option>
        </select>
        
        <select id="historyCategory" onchange="showPriceHistory()">
          <option value="all">Lahat ng Kategorya</option>
          <!-- Options will be loaded dynamically -->
        </select>
      </div>
      
      <div class="history-content" id="historyContent">
        <div class="loading" id="historyLoading">
          Kinukuha ang kasaysayan ng presyo...
        </div>
      </div>
    </div>

    <!-- Price Prediction Section -->
    <div class="prediction-section">
      <h3 style="text-align: center; margin-bottom: 15px; color: #5B3A29;">
        <i class="fas fa-chart-line"></i> Hula ng Presyo sa Hinaharap
      </h3>
      
      <div class="prediction-controls">
        <select id="predictionType">
          <!-- Options will be loaded dynamically -->
        </select>
        
        <select id="predictionWeeks">
          <option value="1">1 Linggo Mula Ngayon</option>
          <option value="2">2 Linggo Mula Ngayon</option>
          <option value="4">1 Buwan Mula Ngayon</option>
          <option value="8">2 Buwan Mula Ngayon</option>
        </select>
      </div>
      
      <button onclick="predictPrice()" style="
        width: 100%;
        padding: 12px;
        background-color: #6B8E23;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-bottom: 15px;
      ">
        <i class="fas fa-calculator"></i> Hulaan ang Presyo
      </button>
      
      <div class="prediction-result" id="predictionResult" style="display: none;">
        <p>Tinatayang Presyo:</p>
        <div class="predicted-price" id="predictedPrice">-</div>
        <p id="predictionDetails">-</p>
        <small>Batay sa iyong CSV data gamit ang Linear Regression</small>
      </div>

      <div class="loading" id="predictionLoading" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> Kinakalkula ang hula...
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="kalendaryo.html" class="nav-item">
      <i class="fas fa-calendar-alt nav-icon"></i>
      <span class="nav-label">Kalendaryo ng Pagsasaka</span>
    </a>
    <a href="suriin.html" class="nav-item">
      <i class="fas fa-search nav-icon"></i>
      <span class="nav-label">Suriin ang Palay</span>
    </a>
    <a href="tanong.html" class="nav-item">
      <i class="fas fa-question-circle nav-icon"></i>
      <span class="nav-label">Ask Juan</span>
    </a>
    <a href="index.html" class="nav-item">
      <i class="fas fa-sign-out-alt nav-icon"></i>
      <span class="nav-label">Log Out</span>
    </a>
  </nav>

  <script>
    // ðŸ”„ UPDATE THIS WITH YOUR BACKEND URL
    const API_URL = 'https://riceup-backend.onrender.com'; // Change this after deployment

    // Load available rice types from backend
    async function loadRiceTypes() {
      try {
        const response = await fetch(`${API_URL}/prices/types`);
        if (response.ok) {
          const data = await response.json();
          populateDropdowns(data);
        }
      } catch (error) {
        console.error('Error loading rice types:', error);
        populateFallbackTypes();
      }
    }

    function populateDropdowns(typesData) {
      const predictionTypeSelect = document.getElementById('predictionType');
      const historyCategorySelect = document.getElementById('historyCategory');
      
      predictionTypeSelect.innerHTML = '';
      historyCategorySelect.innerHTML = '<option value="all">Lahat ng Kategorya</option>';
      
      for (const [riceType, categories] of Object.entries(typesData)) {
        categories.forEach(category => {
          const displayName = getDisplayName(riceType, category);
          const value = `${riceType}|${category}`;
          
          // Add to prediction dropdown
          const predictionOption = new Option(displayName, value);
          predictionTypeSelect.add(predictionOption);
          
          // Add to history category dropdown
          const historyOption = new Option(displayName, value);
          historyCategorySelect.add(historyOption);
        });
      }
    }

    function populateFallbackTypes() {
      const predictionTypeSelect = document.getElementById('predictionType');
      const historyCategorySelect = document.getElementById('historyCategory');
      
      const fallbackOptions = [
        {value: "KADIWA|Premium", display: "Kadiwa - Premium"},
        {value: "KADIWA|Well_Milled", display: "Kadiwa - Well Milled"},
        {value: "KADIWA|Regular_Milled", display: "Kadiwa - Regular Milled"},
        {value: "KADIWA|P20", display: "Kadiwa - P20"},
        {value: "LOCAL|Special", display: "Local - Special"},
        {value: "LOCAL|Premium", display: "Local - Premium"},
        {value: "LOCAL|Well_Milled", display: "Local - Well Milled"},
        {value: "LOCAL|Regular_Milled", display: "Local - Regular Milled"},
        {value: "IMPORTED|Special", display: "Imported - Special"},
        {value: "IMPORTED|Premium", display: "Imported - Premium"},
        {value: "IMPORTED|Well_Milled", display: "Imported - Well Milled"},
        {value: "IMPORTED|Regular_Milled", display: "Imported - Regular Milled"}
      ];
      
      fallbackOptions.forEach(option => {
        const predictionOption = new Option(option.display, option.value);
        const historyOption = new Option(option.display, option.value);
        
        predictionTypeSelect.add(predictionOption);
        historyCategorySelect.add(historyOption);
      });
    }

    function getDisplayName(type, category) {
      const typeNames = {
        'KADIWA': 'Kadiwa',
        'LOCAL': 'Local',
        'IMPORTED': 'Imported'
      };
      
      const categoryNames = {
        'Well_Milled': 'Well Milled',
        'Special': 'Special',
        'Premium': 'Premium', 
        'Regular_Milled': 'Regular Milled',
        'P20': 'P20'
      };
      
      return `${typeNames[type]} - ${categoryNames[category]}`;
    }

    // Load current prices
    async function loadCurrentPrices() {
      const filterType = document.getElementById('priceTypeFilter').value;
      const loadingIndicator = document.getElementById('loadingIndicator');
      const riceContainer = document.getElementById('riceTypesContainer');
      
      loadingIndicator.style.display = 'block';
      riceContainer.innerHTML = '';
      riceContainer.appendChild(loadingIndicator);

      try {
        const response = await fetch(`${API_URL}/prices/current`);
        if (response.ok) {
          const data = await response.json();
          displayCurrentPrices(data.current_prices, filterType, data.as_of_date);
        } else {
          throw new Error('API response not OK');
        }
      } catch (error) {
        console.error('Error loading prices:', error);
        displayFallbackPrices(filterType);
      }
    }

    function displayCurrentPrices(prices, filterType, asOfDate) {
      const riceContainer = document.getElementById('riceTypesContainer');
      const priceBox = document.getElementById('pricePrintBox');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const lastUpdated = document.getElementById('lastUpdated');

      loadingIndicator.style.display = 'none';
      riceContainer.innerHTML = '';

      // Filter prices if needed and exclude NFA rice
      let filteredPrices = prices.filter(price => price.type !== 'NFA_RICE');
      if (filterType !== 'all') {
        filteredPrices = filteredPrices.filter(price => price.type === filterType);
      }

      if (filteredPrices.length === 0) {
        riceContainer.innerHTML = '<div class="error">Walang presyo na available para sa napiling uri.</div>';
        return;
      }

      // Display each price
      filteredPrices.forEach(price => {
        const displayName = getDisplayName(price.type, price.category);
        const riceElement = document.createElement('div');
        riceElement.className = 'rice-type';
        riceElement.innerHTML = `
          <span class="rice-type-name">${displayName}</span>
          <span class="rice-type-price">â‚±${price.price}/kg</span>
        `;
        riceContainer.appendChild(riceElement);
      });

      // Calculate average price
      const averagePrice = filteredPrices.reduce((sum, price) => sum + price.price, 0) / filteredPrices.length;
      
      priceBox.innerHTML = `
        <p>Average Presyo:</p>
        <p>â‚±${averagePrice.toFixed(2)}/kg</p>
        <p><small>Batay sa ${filteredPrices.length} uri ng bigas</small></p>
      `;

      lastUpdated.textContent = `Huling na-update: ${new Date(asOfDate).toLocaleDateString('en-PH')}`;
    }

    function displayFallbackPrices(filterType) {
      const riceContainer = document.getElementById('riceTypesContainer');
      const priceBox = document.getElementById('pricePrintBox');
      const loadingIndicator = document.getElementById('loadingIndicator');

      loadingIndicator.style.display = 'none';
      
      const fallbackPrices = [
        { type: "KADIWA", category: "Premium", name: "Kadiwa - Premium", price: "â‚±43.00" },
        { type: "KADIWA", category: "Well_Milled", name: "Kadiwa - Well Milled", price: "â‚±35.00" },
        { type: "KADIWA", category: "Regular_Milled", name: "Kadiwa - Regular Milled", price: "â‚±33.00" },
        { type: "KADIWA", category: "P20", name: "Kadiwa - P20", price: "â‚±20.00" },
        { type: "LOCAL", category: "Special", name: "Local - Special", price: "â‚±48.75" },
        { type: "LOCAL", category: "Premium", name: "Local - Premium", price: "â‚±45.25" },
        { type: "LOCAL", category: "Well_Milled", name: "Local - Well Milled", price: "â‚±42.50" },
        { type: "LOCAL", category: "Regular_Milled", name: "Local - Regular Milled", price: "â‚±39.75" },
        { type: "IMPORTED", category: "Special", name: "Imported - Special", price: "â‚±52.25" },
        { type: "IMPORTED", category: "Premium", name: "Imported - Premium", price: "â‚±48.75" },
        { type: "IMPORTED", category: "Well_Milled", name: "Imported - Well Milled", price: "â‚±45.80" },
        { type: "IMPORTED", category: "Regular_Milled", name: "Imported - Regular Milled", price: "â‚±43.00" }
      ];

      let filteredPrices = fallbackPrices;
      if (filterType !== 'all') {
        filteredPrices = fallbackPrices.filter(price => price.type === filterType);
      }

      filteredPrices.forEach(rice => {
        const riceElement = document.createElement('div');
        riceElement.className = 'rice-type';
        riceElement.innerHTML = `
          <span class="rice-type-name">${rice.name}</span>
          <span class="rice-type-price">${rice.price}/kg</span>
        `;
        riceContainer.appendChild(riceElement);
      });

      const averagePrice = filteredPrices.reduce((sum, rice) => {
        const price = parseFloat(rice.price.replace('â‚±', ''));
        return sum + price;
      }, 0) / filteredPrices.length;

      priceBox.innerHTML = `
        <p>Average Presyo ng Bigas:</p>
        <p>â‚±${averagePrice.toFixed(2)}/kg</p>
      `;
    }

    // Price History
    async function showPriceHistory() {
      const historyType = document.getElementById('historyType').value;
      const historyCategory = document.getElementById('historyCategory').value;
      const historyContent = document.getElementById('historyContent');
      const historyLoading = document.getElementById('historyLoading');

      historyLoading.style.display = 'block';

      try {
        let url = `${API_URL}/prices/historical`;
        const params = new URLSearchParams();
        
        if (historyType !== 'all') {
          params.append('type', historyType);
        }
        if (historyCategory !== 'all') {
          const [type, category] = historyCategory.split('|');
          params.append('type', type);
          params.append('category', category);
        }
        
        if (params.toString()) {
          url += '?' + params.toString();
        }

        const response = await fetch(url);
        if (response.ok) {
          const data = await response.json();
          displayPriceHistory(data.historical_data, historyType, historyCategory);
        } else {
          throw new Error('API response not OK');
        }
      } catch (error) {
        console.error('Error loading history:', error);
        displayFallbackHistory();
      } finally {
        historyLoading.style.display = 'none';
      }
    }

    function displayPriceHistory(data, historyType, historyCategory) {
      const historyContent = document.getElementById('historyContent');
      
      // Filter out NFA rice data
      data = data.filter(item => item.type !== 'NFA_RICE');
      
      if (!data || data.length === 0) {
        historyContent.innerHTML = '<div class="error">Walang datos na available para sa napiling uri at kategorya.</div>';
        return;
      }

      // Sort by date (newest first)
      data.sort((a, b) => new Date(b.date) - new Date(a.date));

      let tableHTML = `
        <h4 style="text-align: center; margin-bottom: 15px; color: #5B3A29;">
          Kasaysayan ng Presyo - ${getHistoryTitle(historyType, historyCategory)}
        </h4>
        <table class="history-table">
          <thead>
            <tr>
              <th>Petsa</th>
              <th>Uri</th>
              <th>Kategorya</th>
              <th>Presyo (â‚±/kg)</th>
              <th>Pagbabago</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach((item, index) => {
        let change = '';
        let changeClass = '';
        
        if (index < data.length - 1) {
          const prevPrice = data[index + 1].price;
          const changePercent = ((item.price - prevPrice) / prevPrice * 100).toFixed(1);
          
          if (changePercent > 0) {
            change = `+${changePercent}%`;
            changeClass = 'price-positive';
          } else if (changePercent < 0) {
            change = `${changePercent}%`;
            changeClass = 'price-negative';
          } else {
            change = '0%';
          }
        }
        
        tableHTML += `
          <tr>
            <td>${new Date(item.date).toLocaleDateString('en-PH')}</td>
            <td>${getDisplayName(item.type, '').split(' - ')[0]}</td>
            <td>${getDisplayName('', item.category).split(' - ')[1] || item.category}</td>
            <td><strong>â‚±${item.price.toFixed(2)}</strong></td>
            <td class="${changeClass}">${change}</td>
          </tr>
        `;
      });
      
      tableHTML += `
          </tbody>
        </table>
        <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #666;">
          Ipinapakita ang ${data.length} na rekord
        </div>
      `;
      
      historyContent.innerHTML = tableHTML;
    }

    function getHistoryTitle(historyType, historyCategory) {
      if (historyCategory !== 'all') {
        const [type, category] = historyCategory.split('|');
        return getDisplayName(type, category);
      } else if (historyType !== 'all') {
        return getDisplayName(historyType, '');
      } else {
        return 'Lahat ng Uri ng Bigas';
      }
    }

    function displayFallbackHistory() {
      const historyContent = document.getElementById('historyContent');
      historyContent.innerHTML = '<div class="error">Hindi makukuha ang kasaysayan ng presyo sa ngayon. Pakisubukan muli mamaya.</div>';
    }

    // Price Prediction
    async function predictPrice() {
      const [riceType, category] = document.getElementById('predictionType').value.split('|');
      const weeksAhead = parseInt(document.getElementById('predictionWeeks').value);
      const resultDiv = document.getElementById('predictionResult');
      const loadingDiv = document.getElementById('predictionLoading');
      const priceDiv = document.getElementById('predictedPrice');
      const detailsDiv = document.getElementById('predictionDetails');

      loadingDiv.style.display = 'block';
      resultDiv.style.display = 'none';

      try {
        const response = await fetch(`${API_URL}/predict`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: riceType,
            category: category,
            weeks_ahead: weeksAhead
          })
        });

        if (response.ok) {
          const data = await response.json();
          priceDiv.textContent = `â‚±${data.predicted_price}/kg`;
          detailsDiv.textContent = `Presyo ng ${getDisplayName(riceType, category)} para sa ${data.prediction_date}`;
          resultDiv.style.display = 'block';
        } else {
          throw new Error('API response not OK');
        }
      } catch (error) {
        console.error('Prediction error:', error);
        priceDiv.textContent = 'â‚±--.--/kg';
        detailsDiv.textContent = 'Serbisyo pansamantalang hindi available';
        resultDiv.style.display = 'block';
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Initialize the application
    window.onload = () => {
      loadRiceTypes();
      loadCurrentPrices();
      showPriceHistory();
    };
  </script>
</body>
</html>
